<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blue Lock Manager (Live System)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --primary: #3b82f6;
            --accent: #f43f5e;
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --border: rgba(255,255,255,0.1);
            
            /* Economy & Ranks */
            --money: #4ade80;
            --rank-s: #fbbf24;
            --rank-a: #a855f7;
            --rank-b: #22c55e;
            --rank-c: #94a3b8;
            
            /* VFX */
            --glow-s: 0 0 15px rgba(251, 191, 36, 0.4);
            --glow-a: 0 0 12px rgba(168, 85, 247, 0.4);
        }

        * { box-sizing: border-box; font-family: 'Outfit', sans-serif; margin: 0; padding: 0; }
        
        body {
            background-color: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-bottom: 50px;
        }

        /* --- SECURITY LAYERS --- */
        .admin-only { display: none !important; }
        body.is-admin .admin-only { display: block !important; }
        body.is-admin .admin-only-flex { display: flex !important; }
        body.is-admin .admin-only-inline { display: inline-block !important; }

        /* Login Button Styling */
        .auth-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 800;
        }
        .auth-btn:hover { background: var(--primary); color: white; }
        .auth-btn.logout { border-color: var(--accent); color: var(--accent); }
        .auth-btn.logout:hover { background: var(--accent); color: white; }

        /* --- UI Elements --- */
        nav {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .nav-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-muted);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 1px;
        }
        .nav-btn:hover, .nav-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.4);
        }

        main { flex: 1; padding: 2rem; max-width: 1400px; margin: 0 auto; width: 100%; }
        .section { display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        /* Inputs & Buttons */
        .input-group { margin-bottom: 1rem; }
        input, select {
            width: 100%;
            background: #0f172a;
            border: 1px solid var(--border);
            color: white;
            padding: 0.8rem;
            border-radius: 6px;
            font-size: 1rem;
        }
        input:focus { outline: none; border-color: var(--primary); }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 800;
            text-transform: uppercase;
            width: 100%;
            transition: 0.2s;
        }
        .btn:hover { filter: brightness(1.2); }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; width: auto; }
        .btn-danger { background: var(--accent); }
        .btn-edit { background: #64748b; }

        .player-link {
            color: var(--text);
            cursor: pointer;
            text-decoration: none;
            border-bottom: 1px dotted rgba(255,255,255,0.3);
            transition: 0.2s;
        }
        .player-link:hover { color: var(--primary); border-color: var(--primary); }

        .match-sheet-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .stat-input-row {
            display: grid;
            grid-template-columns: 1.5fr 1fr 0.6fr 0.6fr 0.6fr;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 0.5rem;
            background: rgba(0,0,0,0.2);
            padding: 0.5rem;
            border-radius: 6px;
        }
        .stat-input-row label { font-size: 0.7rem; color: #64748b; text-align: center; text-transform: uppercase; }
        .stat-input { text-align: center; padding: 0.4rem; }
        select.inp-leg { font-size: 0.8rem; padding: 0.4rem; background: #334155; color: #f8fafc; border: 1px solid rgba(255,255,255,0.1); }

        .roster-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem; }
        .player-row { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        
        .result-card { border-left: 5px solid var(--primary); position: relative; }
        .result-actions { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: flex-end; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; }
        th { text-align: left; color: #64748b; font-size: 0.75rem; text-transform: uppercase; padding: 1rem; }
        td { padding: 1rem; border-top: 1px solid rgba(255,255,255,0.05); font-weight: 500; }
        tr:hover td { background: rgba(255,255,255,0.02); }
        
        .money-val { color: var(--money); font-weight: 800; font-family: 'Courier New', monospace; letter-spacing: -0.5px; }

        /* Rank VFX */
        .rank-row-1 td { color: var(--rank-s); border-bottom: 1px solid var(--rank-s) !important; background: linear-gradient(90deg, rgba(251, 191, 36, 0.1), transparent); }
        .rank-row-2 td { color: #e2e8f0; border-bottom: 1px solid #e2e8f0 !important; }
        .rank-row-3 td { color: #d97706; border-bottom: 1px solid #d97706 !important; }
        .rank-icon { margin-right: 5px; }

        /* Modals */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 200; backdrop-filter: blur(5px);
            align-items: center; justify-content: center;
        }
        .profile-card {
            background: #1e293b; width: 600px; max-width: 95%; max-height: 90vh;
            border-radius: 16px; border: 1px solid var(--primary);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .profile-header {
            background: linear-gradient(135deg, #0f172a, #1e293b);
            padding: 1.5rem; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .profile-body { padding: 1.5rem; overflow-y: auto; }
        
        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem; }
        .stat-box {
            background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px; text-align: center;
            border: 1px solid var(--border); position: relative;
        }
        .stat-box small { display: block; color: #94a3b8; font-size: 0.7rem; text-transform: uppercase; margin-bottom: 5px; }
        .stat-box strong { font-size: 1.2rem; }

        .rank-s { color: var(--rank-s); text-shadow: var(--glow-s); }
        .rank-a { color: var(--rank-a); text-shadow: var(--glow-a); }
        .rank-b { color: var(--rank-b); }
        .rank-c { color: var(--rank-c); }

        .history-item { padding: 0.8rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .tag { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; background: #334155; color: #cbd5e1; }

        @media (max-width: 900px) {
            .match-sheet-grid { grid-template-columns: 1fr; }
            .stat-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

    <nav>
        <button class="nav-btn active" onclick="switchTab('registry')">Registry</button>
        <button class="nav-btn" onclick="switchTab('match')">Match Center</button>
        <button class="nav-btn" onclick="switchTab('results')">Results</button>
        <button class="nav-btn" onclick="switchTab('lb-player')">Player Leaderboard</button>
        <div style="margin-left: auto;">
            <button id="authBtn" class="auth-btn" onclick="openLogin()">ADMIN LOGIN</button>
        </div>
    </nav>

    <main>
        <div id="registry" class="section active">
            <div class="admin-only" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                <div class="card">
                    <h3>Create Team</h3>
                    <div class="input-group"><input type="text" id="regTeamName" placeholder="Team Name"></div>
                    <div class="input-group"><input type="color" id="regTeamColor" value="#3b82f6" style="height:40px;"></div>
                    <button class="btn" onclick="addTeam()">Register Team</button>
                </div>
                <div class="card">
                    <h3>Sign Player</h3>
                    <div class="input-group"><input type="text" id="regPlayerName" placeholder="Player Name"></div>
                    <div class="input-group"><select id="regPlayerTeam"><option>Select Team...</option></select></div>
                    <button class="btn" onclick="addPlayer()">Sign Player</button>
                </div>
            </div>

            <h2>Active Rosters</h2>
            <div id="rosterList" class="roster-grid"></div>

            <div class="admin-only" style="margin-top: 4rem; border-top: 1px solid var(--accent); padding-top: 2rem;">
                <h3 style="color:var(--accent)">Danger Zone</h3>
                <p style="color:#64748b; margin-bottom:1rem;">Wipe all data including players, teams, and history.</p>
                <button class="btn btn-danger" onclick="wipeData()">RESET SYSTEM</button>
            </div>
        </div>

        <div id="match" class="section">
            <div id="matchSetup" class="card admin-only" style="text-align: center; max-width: 600px; margin: 0 auto;">
                <h2>Start New Match</h2>
                <div style="display: flex; gap: 1rem; align-items: center; margin: 2rem 0;">
                    <select id="setupTeamA"><option>Team A</option></select>
                    <span style="font-weight:800; font-size: 1.5rem;">VS</span>
                    <select id="setupTeamB"><option>Team B</option></select>
                </div>
                <button class="btn" onclick="initMatchSheet()">KICK OFF</button>
            </div>

            <div id="visitorMatchMsg" style="text-align:center; padding: 4rem; color: #64748b;">
                <h3>î‰” Only Admins can start matches.</h3>
                <p>Login to access the Match Sheet.</p>
            </div>

            <div id="matchSheet" style="display: none;">
                <div class="card" style="position:sticky; top: 80px; z-index:90; background: rgba(15,23,42,0.95); border: 1px solid var(--primary);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="text-align: center; width: 40%;">
                            <h2 id="sheetNameA" style="margin:0;">Team A</h2>
                            <div id="sheetScoreA" style="font-size: 3rem; font-weight:800; line-height:1;">0</div>
                        </div>
                        <div style="font-size: 2rem; color: #64748b;">-</div>
                        <div style="text-align: center; width: 40%;">
                            <h2 id="sheetNameB" style="margin:0;">Team B</h2>
                            <div id="sheetScoreB" style="font-size: 3rem; font-weight:800; line-height:1;">0</div>
                        </div>
                    </div>
                </div>

                <div class="match-sheet-grid">
                    <div class="card" id="panelA">
                        <div class="sheet-header">
                            <h3>Team Stats</h3>
                            <div style="display:flex; gap:0.5rem; align-items:center;">
                                <span style="font-size:0.8rem; color:#f43f5e;">FOULS</span>
                                <input type="number" id="foulsA" value="0" min="0" onchange="calcLiveScore()" style="width:50px; text-align:center;">
                            </div>
                        </div>
                        <div id="rowsA"></div>
                    </div>
                    <div class="card" id="panelB">
                        <div class="sheet-header">
                            <h3>Team Stats</h3>
                            <div style="display:flex; gap:0.5rem; align-items:center;">
                                <span style="font-size:0.8rem; color:#f43f5e;">FOULS</span>
                                <input type="number" id="foulsB" value="0" min="0" onchange="calcLiveScore()" style="width:50px; text-align:center;">
                            </div>
                        </div>
                        <div id="rowsB"></div>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button class="btn btn-danger" onclick="cancelMatch()">Discard</button>
                    <button class="btn" onclick="finalizeMatch()">FULL TIME</button>
                </div>
            </div>
        </div>

        <div id="results" class="section">
            <h2>Match History</h2>
            <div id="matchHistoryList"></div>
        </div>

        <div id="lb-player" class="section">
            <div style="margin-bottom: 1rem; display: flex; gap: 0.5rem;">
                <button class="nav-btn active" onclick="renderPlayerLB('value')">Top Value</button>
                <button class="nav-btn" onclick="renderPlayerLB('goals')">Top Scorer</button>
                <button class="nav-btn" onclick="renderPlayerLB('assists')">Top Assists</button>
                <button class="nav-btn" onclick="renderPlayerLB('saves')">Top Saves</button>
            </div>
            <div class="card">
                <table id="tablePlayer">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Player</th>
                            <th>Team</th>
                            <th>Stats (G/A/S)</th>
                            <th>Value ($)</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyPlayer"></tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="loginModal" class="modal-overlay">
        <div class="card" style="width: 350px;">
            <h3 style="text-align:center; margin-bottom:1.5rem;">Admin Access</h3>
            <div class="input-group">
                <input type="email" id="loginEmail" placeholder="admin@bluelock.com">
            </div>
            <div class="input-group">
                <input type="password" id="loginPass" placeholder="Password">
            </div>
            <div style="display:flex; gap:1rem;">
                <button class="btn" onclick="performLogin()">Login</button>
                <button class="btn btn-danger" onclick="closeLogin()">Cancel</button>
            </div>
            <div id="loginError" style="color:var(--accent); margin-top:1rem; text-align:center; font-size:0.9rem;"></div>
        </div>
    </div>

    <div id="editModal" class="modal-overlay">
        <div class="card" style="width: 400px; max-width:90%;">
            <h3>Edit / Transfer Player</h3>
            <div class="input-group"><input type="text" id="editName"></div>
            <div class="input-group"><label style="font-size:0.8rem; color:#94a3b8;">Current Team</label><select id="editTeamSelect"></select></div>
            <div style="display:flex; gap:1rem;">
                <button class="btn" onclick="saveEdit()">Save Changes</button>
                <button class="btn btn-danger" onclick="closeEdit()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="profileModal" class="modal-overlay">
        <div class="profile-card">
            <div class="profile-header">
                <div>
                    <h2 id="profName" style="margin:0; border:none; padding:0;"></h2>
                    <span id="profTeam" style="color:#94a3b8; font-size:0.9rem;"></span>
                </div>
                <div id="profVal" class="money-val" style="font-size:1.5rem;"></div>
            </div>
            <div class="profile-body">
                <h4 style="color:#94a3b8; margin-bottom:1rem; text-transform:uppercase; letter-spacing:1px;">Leg Analysis</h4>
                <div class="stat-grid">
                    <div class="stat-box"><small>Goals/Leg</small><strong id="analG">0.0</strong></div>
                    <div class="stat-box"><small>Assists/Leg</small><strong id="analA">0.0</strong></div>
                    <div class="stat-box"><small>Saves/Leg</small><strong id="analS">0.0</strong></div>
                    <div class="stat-box"><small>Value/Leg</small><strong id="analV" style="color:var(--money)">$0k</strong></div>
                </div>
                <h4 style="color:#94a3b8; margin-bottom:1rem; text-transform:uppercase; letter-spacing:1px;">Match History</h4>
                <div id="profHistory" class="card" style="background: rgba(0,0,0,0.2); max-height: 200px; overflow-y: auto;"></div>
                <h4 style="color:#94a3b8; margin:1rem 0; text-transform:uppercase; letter-spacing:1px;">Transfer Record</h4>
                <div id="profTransfers" class="card" style="background: rgba(0,0,0,0.2); max-height: 150px; overflow-y: auto;"></div>
                <button class="btn" style="margin-top:1rem;" onclick="closeProfile()">Close Profile</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        // --- FINAL FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBZ19PzqxVot1gM41rjVBDaOVkCmqJB5mI",
            authDomain: "myleaguemanagement-36bd4.firebaseapp.com",
            databaseURL: "https://myleaguemanagement-36bd4-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "myleaguemanagement-36bd4",
            storageBucket: "myleaguemanagement-36bd4.firebasestorage.app",
            messagingSenderId: "126291574058",
            appId: "1:126291574058:web:3ff023573bd385e81ef253"
        };
        // -----------------------------

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);
        const dbRef = ref(database, 'blue_lock_data');

        // Global State
        let db = { teams: [], players: [], matches: [], transfers: [] };
        
        // Listen for Data Updates
        onValue(dbRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                db = data;
                if (!db.teams) db.teams = [];
                if (!db.players) db.players = [];
                if (!db.matches) db.matches = [];
                if (!db.transfers) db.transfers = []; 
            } else {
                db = { teams: [], players: [], matches: [], transfers: [] };
            }
            refreshUI();
        });

        // Listen for Auth Changes
        onAuthStateChanged(auth, (user) => {
            const authBtn = document.getElementById('authBtn');
            const visitorMsg = document.getElementById('visitorMatchMsg');
            
            if (user) {
                // User is signed in (Admin)
                document.body.classList.add('is-admin');
                authBtn.innerText = "LOGOUT";
                authBtn.classList.add('logout');
                authBtn.onclick = () => signOut(auth);
                if(visitorMsg) visitorMsg.style.display = 'none';
            } else {
                // User is signed out (Visitor)
                document.body.classList.remove('is-admin');
                authBtn.innerText = "ADMIN LOGIN";
                authBtn.classList.remove('logout');
                authBtn.onclick = () => openLogin();
                if(visitorMsg) visitorMsg.style.display = 'block';
                // Close any admin panels if open
                if(activeMatch) window.cancelMatch();
            }
        });

        // --- GLOBAL FUNCTIONS ---
        window.saveData = function() { set(dbRef, db); }
        
        window.wipeData = function() {
            const confirmation = prompt("WARNING: This will delete ALL teams, players, and history.\nType 'delete' to confirm.");
            if (confirmation && confirmation.toLowerCase() === 'delete') {
                db = { teams: [], players: [], matches: [], transfers: [] };
                set(dbRef, db);
                alert("System Reset Complete.");
            }
        }

        // --- AUTH UI FUNCTIONS ---
        window.openLogin = function() {
            document.getElementById('loginModal').style.display = 'flex';
        }
        window.closeLogin = function() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('loginError').innerText = '';
        }
        window.performLogin = function() {
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;
            
            signInWithEmailAndPassword(auth, email, pass)
                .then(() => {
                    window.closeLogin();
                })
                .catch((error) => {
                    document.getElementById('loginError').innerText = "Error: " + error.message;
                });
        }

        // --- APP LOGIC (Same as Phase 3) ---
        const PRICES = { GOAL: 1000000, ASSIST: 500000, SAVE: 200000 };
        let activeMatch = null;
        let editingPlayerId = null;

        window.switchTab = function(id) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            if(id === 'lb-player') renderPlayerLB('value');
            if(id === 'results') renderResults();
        }

        function refreshUI() {
            const selects = ['regPlayerTeam', 'setupTeamA', 'setupTeamB', 'editTeamSelect'];
            selects.forEach(id => {
                const el = document.getElementById(id);
                if(!el) return;
                const current = el.value;
                el.innerHTML = '<option value="">Select Team...</option>';
                db.teams.forEach(t => el.innerHTML += `<option value="${t.id}">${t.name}</option>`);
                el.value = current;
            });

            const rosterDiv = document.getElementById('rosterList');
            rosterDiv.innerHTML = '';
            db.teams.forEach(t => {
                const pList = db.players.filter(p => p.teamId == t.id);
                rosterDiv.innerHTML += `
                    <div class="card" style="border-top: 3px solid ${t.color}">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                            <h3 style="color:${t.color}">${t.name}</h3>
                            <button class="btn-sm btn-danger admin-only-inline" onclick="deleteTeam(${t.id})">Del</button>
                        </div>
                        <div>
                            ${pList.map(p => `
                                <div class="player-row">
                                    <span class="player-link" onclick="openProfile('${p.id}')">${p.name}</span>
                                    <button class="btn-sm btn-edit admin-only-inline" onclick="openEdit('${p.id}')">Edit</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
            });
        }

        window.addTeam = function() {
            const name = document.getElementById('regTeamName').value;
            const color = document.getElementById('regTeamColor').value;
            if(!name) return;
            db.teams.push({ id: Date.now(), name, color });
            document.getElementById('regTeamName').value = '';
            window.saveData();
        }

        window.deleteTeam = function(id) {
            if(confirm("Delete team?")) { db.teams = db.teams.filter(t => t.id != id); window.saveData(); }
        }

        window.addPlayer = function() {
            const name = document.getElementById('regPlayerName').value;
            const tid = document.getElementById('regPlayerTeam').value;
            if(!name || !tid) return;
            db.players.push({ id: Date.now(), name, teamId: tid });
            document.getElementById('regPlayerName').value = '';
            window.saveData();
        }

        window.openEdit = function(pid) {
            const p = db.players.find(x => x.id == pid);
            editingPlayerId = pid;
            document.getElementById('editName').value = p.name;
            document.getElementById('editTeamSelect').value = p.teamId;
            document.getElementById('editModal').style.display = 'flex';
        }

        window.saveEdit = function() {
            if(!db.transfers) db.transfers = [];
            const p = db.players.find(x => x.id == editingPlayerId);
            const newName = document.getElementById('editName').value;
            const newTeamId = document.getElementById('editTeamSelect').value;
            
            if(p.teamId != newTeamId) {
                db.transfers.push({ 
                    playerId: String(p.id), 
                    from: String(p.teamId), 
                    to: String(newTeamId), 
                    date: new Date().toLocaleDateString() 
                });
            }
            p.name = newName; p.teamId = newTeamId;
            document.getElementById('editModal').style.display = 'none';
            window.saveData();
        }
        window.closeEdit = function() { document.getElementById('editModal').style.display = 'none'; }

        // --- PROFILE LOGIC ---
        function getRankClass(val, type) {
            if (type === 'save') {
                if(val >= 12) return 'rank-s'; if(val >= 8) return 'rank-a'; if(val >= 4) return 'rank-b'; return 'rank-c';
            } else {
                if(val >= 4) return 'rank-s'; if(val >= 3) return 'rank-a'; if(val >= 2) return 'rank-b'; return 'rank-c';
            }
        }

        window.openProfile = function(pid) {
            if(!db.transfers) db.transfers = [];
            const p = db.players.find(x => String(x.id) == String(pid));
            if(!p) return;
            const team = db.teams.find(t => t.id == p.teamId);
            
            let totalLegs = 0, sumG = 0, sumA = 0, sumS = 0, sumV = 0;
            let historyHTML = '';
            const playerMatches = db.matches.filter(m => m.stats.some(s => String(s.playerId) === String(pid)));

            playerMatches.forEach(m => {
                const stat = m.stats.find(s => String(s.playerId) === String(pid));
                if (!stat) return;
                let legsPlayed = (stat.leg === 'Full') ? 2 : 1;
                totalLegs += legsPlayed;
                sumG += stat.g; sumA += stat.a; sumS += stat.s; sumV += stat.val;
                
                const tA = db.teams.find(t => t.id == m.teamA);
                const tB = db.teams.find(t => t.id == m.teamB);
                historyHTML += `
                <div class="history-item">
                    <div>
                        <span style="color:${tA.color}">${tA.name}</span> vs <span style="color:${tB.color}">${tB.name}</span>
                        <div style="font-size:0.75rem; color:#94a3b8;">${new Date(m.id).toLocaleDateString()}</div>
                    </div>
                    <div style="text-align:right">
                        <span class="tag">${stat.leg || 'Full'}</span>
                        <span style="font-weight:bold; margin-left:8px;">${stat.g}G / ${stat.a}A / ${stat.s}S</span>
                    </div>
                </div>`;
            });

            const gPerLeg = totalLegs > 0 ? (sumG / totalLegs).toFixed(2) : "0.0";
            const aPerLeg = totalLegs > 0 ? (sumA / totalLegs).toFixed(2) : "0.0";
            const sPerLeg = totalLegs > 0 ? (sumS / totalLegs).toFixed(2) : "0.0";
            const vPerLeg = totalLegs > 0 ? (sumV / totalLegs) : 0;
            let valPerLegDisplay = vPerLeg >= 1000000 ? '$' + (vPerLeg/1000000).toFixed(1) + 'M' : '$' + Math.round(vPerLeg/1000) + 'k';

            document.getElementById('profName').innerText = p.name;
            document.getElementById('profTeam').innerText = team ? team.name : 'Free Agent';
            document.getElementById('profVal').innerText = '$' + sumV.toLocaleString('en-US');
            
            const elG = document.getElementById('analG'); elG.innerText = gPerLeg; elG.className = getRankClass(parseFloat(gPerLeg), 'goal');
            const elA = document.getElementById('analA'); elA.innerText = aPerLeg; elA.className = getRankClass(parseFloat(aPerLeg), 'assist');
            const elS = document.getElementById('analS'); elS.innerText = sPerLeg; elS.className = getRankClass(parseFloat(sPerLeg), 'save');
            document.getElementById('analV').innerText = valPerLegDisplay;

            const playerTransfers = db.transfers.filter(t => String(t.playerId) === String(pid));
            let transHTML = playerTransfers.length ? '' : '<div style="padding:1rem; color:#64748b; font-style:italic;">No transfers recorded.</div>';
            
            playerTransfers.forEach(t => {
                const fromT = db.teams.find(x => String(x.id) == String(t.from));
                const toT = db.teams.find(x => String(x.id) == String(t.to));
                transHTML += `
                <div class="history-item">
                    <span style="color:${fromT?fromT.color:'#94a3b8'}">${fromT?fromT.name:'Deleted Team'}</span>
                    <span style="color:#64748b;"> âž” </span>
                    <span style="color:${toT?toT.color:'#94a3b8'}">${toT?toT.name:'Deleted Team'}</span>
                    <span style="font-size:0.8rem; color:#64748b;">${t.date}</span>
                </div>`;
            });

            document.getElementById('profHistory').innerHTML = historyHTML || '<div style="padding:1rem">No matches played.</div>';
            document.getElementById('profTransfers').innerHTML = transHTML;
            document.getElementById('profileModal').style.display = 'flex';
        }
        window.closeProfile = function() { document.getElementById('profileModal').style.display = 'none'; }

        // --- MATCH & EDIT ---
        window.initMatchSheet = function() {
            const tA = document.getElementById('setupTeamA').value;
            const tB = document.getElementById('setupTeamB').value;
            if(!tA || !tB || tA == tB) return alert("Select 2 different teams");
            const teamA = db.teams.find(t => t.id == tA);
            const teamB = db.teams.find(t => t.id == tB);

            activeMatch = {
                id: Date.now(), teamA: tA, teamB: tB,
                rosterA: db.players.filter(p => p.teamId == tA),
                rosterB: db.players.filter(p => p.teamId == tB)
            };
            document.getElementById('matchSetup').style.display = 'none';
            document.getElementById('matchSheet').style.display = 'block';
            document.getElementById('sheetNameA').innerText = teamA.name; document.getElementById('sheetNameA').style.color = teamA.color;
            document.getElementById('sheetNameB').innerText = teamB.name; document.getElementById('sheetNameB').style.color = teamB.color;
            
            renderRows('rowsA', activeMatch.rosterA, 'A');
            renderRows('rowsB', activeMatch.rosterB, 'B');
            document.getElementById('foulsA').value = 0;
            document.getElementById('foulsB').value = 0;
            window.calcLiveScore();
        }

        function renderRows(containerId, players, prefix) {
            document.getElementById(containerId).innerHTML = players.map(p => `
                <div class="stat-input-row" data-pid="${p.id}" data-prefix="${prefix}">
                    <div style="font-weight:600; font-size:0.9rem;">${p.name}</div>
                    <select class="stat-input inp-leg"><option value="Full">Full</option><option value="1st">1st</option><option value="2nd">2nd</option></select>
                    <input type="number" class="stat-input inp-g" min="0" value="0" onchange="calcLiveScore()">
                    <input type="number" class="stat-input inp-a" min="0" value="0">
                    <input type="number" class="stat-input inp-s" min="0" value="0">
                </div>
            `).join('');
        }

        window.calcLiveScore = function() {
            let scoreA = 0, scoreB = 0;
            document.querySelectorAll('#rowsA .inp-g').forEach(i => scoreA += parseInt(i.value || 0));
            document.querySelectorAll('#rowsB .inp-g').forEach(i => scoreB += parseInt(i.value || 0));
            const fA = parseInt(document.getElementById('foulsA').value || 0);
            const fB = parseInt(document.getElementById('foulsB').value || 0);
            document.getElementById('sheetScoreA').innerText = Math.max(0, scoreA - fA);
            document.getElementById('sheetScoreB').innerText = Math.max(0, scoreB - fB);
        }

        window.finalizeMatch = function() {
            if(!confirm("End Match?")) return;
            const gather = (prefix) => {
                let goals = 0;
                document.querySelectorAll(`[data-prefix="${prefix}"]`).forEach(row => {
                    const pid = row.getAttribute('data-pid');
                    const leg = row.querySelector('.inp-leg').value;
                    const g = parseInt(row.querySelector('.inp-g').value||0);
                    const a = parseInt(row.querySelector('.inp-a').value||0);
                    const s = parseInt(row.querySelector('.inp-s').value||0);
                    goals += g;
                    activeMatch.stats.push({ playerId: String(pid), leg, g, a, s, val: (g*PRICES.GOAL + a*PRICES.ASSIST + s*PRICES.SAVE) });
                });
                return goals;
            };
            activeMatch.stats = [];
            const gA = gather('A'); const gB = gather('B');
            const fA = parseInt(document.getElementById('foulsA').value || 0);
            const fB = parseInt(document.getElementById('foulsB').value || 0);
            const sA = gA - fA; const sB = gB - fB;

            let winnerId = null;
            if(sA > sB) winnerId = activeMatch.teamA; else if(sB > sA) winnerId = activeMatch.teamB;

            activeMatch.stats.sort((a,b) => b.val - a.val);
            const motm = activeMatch.stats[0]?.val > 0 ? activeMatch.stats[0].playerId : null;
            let mvp = null;
            if(winnerId) {
                const winningRosterIds = (winnerId == activeMatch.teamA ? activeMatch.rosterA : activeMatch.rosterB).map(p=>String(p.id));
                const winnerStats = activeMatch.stats.filter(s => winningRosterIds.includes(String(s.playerId)));
                if(winnerStats.length > 0) mvp = winnerStats[0].playerId;
            } else if(activeMatch.stats.length > 1) mvp = activeMatch.stats[1].playerId;

            db.matches.push({ id: activeMatch.id, teamA: activeMatch.teamA, teamB: activeMatch.teamB, sA, sB, fA, fB, stats: activeMatch.stats, awards: { motm, mvp, winnerId } });
            window.saveData();
            window.cancelMatch();
            window.switchTab('results');
        }

        window.cancelMatch = function() {
            activeMatch = null;
            document.getElementById('matchSheet').style.display = 'none';
            document.getElementById('matchSetup').style.display = 'block';
        }

        window.editMatch = function(matchId) {
            const m = db.matches.find(x => x.id === matchId);
            if(!m) return;
            db.matches = db.matches.filter(x => x.id !== matchId);
            document.getElementById('setupTeamA').value = m.teamA;
            document.getElementById('setupTeamB').value = m.teamB;
            window.initMatchSheet();
            activeMatch.id = m.id;
            document.getElementById('foulsA').value = m.fA;
            document.getElementById('foulsB').value = m.fB;
            m.stats.forEach(s => {
                const row = document.querySelector(`.stat-input-row[data-pid="${s.playerId}"]`);
                if(row) {
                    row.querySelector('.inp-leg').value = s.leg;
                    row.querySelector('.inp-g').value = s.g;
                    row.querySelector('.inp-a').value = s.a;
                    row.querySelector('.inp-s').value = s.s;
                }
            });
            window.calcLiveScore();
            window.switchTab('match');
        }

        window.renderResults = function() {
            const div = document.getElementById('matchHistoryList');
            div.innerHTML = db.matches.map(m => {
                const tA = db.teams.find(t => t.id == m.teamA);
                const tB = db.teams.find(t => t.id == m.teamB);
                const motmName = db.players.find(p => String(p.id) == String(m.awards.motm))?.name || '-';
                const mvpName = db.players.find(p => String(p.id) == String(m.awards.mvp))?.name || '-';
                const statRows = m.stats.filter(s => s.g > 0 || s.a > 0 || s.s > 0).map(s => {
                    const p = db.players.find(x => String(x.id) == String(s.playerId));
                    const legLabel = s.leg && s.leg !== 'Full' ? `(${s.leg})` : '';
                    return `<div><span class="player-link" onclick="openProfile('${s.playerId}')">${p?p.name:'?'}</span> ${legLabel}: ${s.g}G / ${s.a}A / ${s.s}S</div>`;
                }).join('');

                return `
                <div class="card result-card">
                    <div style="display:flex; justify-content:space-between; align-items:center; font-size:1.1rem; font-weight:800;">
                        <span style="color:${tA.color}">${tA.name} <small style="color:#94a3b8; font-size:0.7rem;">(${m.fA} F)</small></span>
                        <span style="font-size:1.5rem">${m.sA} - ${m.sB}</span>
                        <span style="color:${tB.color}">${tB.name} <small style="color:#94a3b8; font-size:0.7rem;">(${m.fB} F)</small></span>
                    </div>
                    <div style="margin-top:0.5rem; display:flex; gap:1rem; font-size:0.8rem;">
                        <span style="color:var(--gold)">MOTM: <span class="player-link" onclick="openProfile('${m.awards.motm}')">${motmName}</span></span>
                        <span style="color:#94a3b8">MVP: <span class="player-link" onclick="openProfile('${m.awards.mvp}')">${mvpName}</span></span>
                    </div>
                    <details style="margin-top:0.5rem;">
                        <summary style="cursor:pointer; color:var(--primary); font-size:0.8rem;">View Player Stats</summary>
                        <div style="margin-top:0.5rem; font-size:0.8rem; color:#cbd5e1; display:grid; grid-template-columns: 1fr 1fr; gap: 5px;">${statRows || '<div style="color:#64748b">No stats recorded</div>'}</div>
                    </details>
                    <div class="result-actions admin-only">
                         <button class="edit-result-btn" onclick="editMatch(${m.id})">EDIT MATCH</button>
                    </div>
                </div>`;
            }).reverse().join('');
        }

        window.renderPlayerLB = function(sortBy) {
            let agg = {};
            db.matches.forEach(m => {
                m.stats.forEach(s => {
                    const pid = String(s.playerId);
                    if(!agg[pid]) agg[pid] = { g:0, a:0, s:0, val:0 };
                    agg[pid].g += s.g; agg[pid].a += s.a; agg[pid].s += s.s; agg[pid].val += s.val;
                });
            });
            const list = Object.keys(agg).map(pid => {
                const p = db.players.find(x => String(x.id) == pid);
                return { ...agg[pid], pid, name: p?.name, teamId: p?.teamId };
            }).sort((a,b) => {
                if(sortBy === 'goals') return b.g - a.g;
                if(sortBy === 'assists') return b.a - a.a;
                if(sortBy === 'saves') return b.s - a.s;
                return b.val - a.val;
            });

            document.getElementById('tbodyPlayer').innerHTML = list.map((p, i) => {
                const team = db.teams.find(t => t.id == p.teamId);
                let rankClass = '';
                if(i === 0) rankClass = 'rank-row-1';
                else if(i === 1) rankClass = 'rank-row-2';
                else if(i === 2) rankClass = 'rank-row-3';

                return `
                <tr class="${rankClass}">
                    <td>${i===0 ? '<span class="rank-icon">ðŸ‘‘</span>' : ''}#${i+1}</td>
                    <td class="player-link" style="color:${team ? team.color : 'white'}; font-weight:800;" onclick="openProfile('${p.pid}')">${p.name || 'Unknown'}</td>
                    <td>${team ? team.name : '-'}</td>
                    <td>${p.g}/${p.a}/${p.s}</td>
                    <td class="money-val">$${p.val.toLocaleString('en-US')}</td>
                </tr>`;
            }).join('');
        }
    </script>
</body>
</html>
